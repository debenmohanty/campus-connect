<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard - Campus Connect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --secondary-color: #2d3748;
            --accent-color: #00b4d8;
            --background-light: #f8f9fa;
            --text-color: #2d3748;
            --text-light: #718096;
            --success-color: #48bb78;
            --info-color: #4299e1;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --sidebar-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-light);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(to bottom, var(--primary-color), var(--primary-hover));
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin: 10px 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .user-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: white;
        }

        .menu-item i {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }

        .menu-item span {
            font-size: 0.9rem;
        }

        .logout-btn {
            margin-top: auto;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            color: white;
            text-decoration: none;
            position: absolute;
            bottom: 20px;
            width: 100%;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .logout-btn i {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background-color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .hamburger {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .content-area {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            min-height: 80vh;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .welcome-message {
            margin-bottom: 20px;
        }

        .dashboard-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .widget {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px -3px rgba(0, 0, 0, 0.1), 0 10px 10px -2px rgba(0, 0, 0, 0.05);
        }

        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .widget-content {
            color: var(--text-color);
        }

        .widget-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .widget-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .widget-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 999;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .hamburger {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Campus Connect</h2>
            </div>
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <div class="user-name" id="faculty-name">Faculty</div>
                    <div class="user-role">Faculty Member</div>
                </div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-target="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-target="profile">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>
                <div class="menu-item" data-target="students">
                    <i class="fas fa-user-graduate"></i>
                    <span>Students</span>
                </div>
                <div class="menu-item" data-target="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
            <a href="#" class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div class="hamburger" id="hamburger">
                    <i class="fas fa-bars"></i>
                </div>
                <div>
                    <h2>Faculty Dashboard</h2>
                </div>
                <div>
                    <i class="fas fa-bell"></i>
                </div>
            </div>

            <div class="content-area">
                <div id="dashboard-section" class="dashboard-section active">
                    <h3 class="content-title">Dashboard</h3>
                    <div class="welcome-message">
                        <p>Welcome to the Faculty Dashboard. As a faculty member, you can oversee student placements and manage company interactions.</p>
                    </div>
                    <div class="dashboard-widgets">
                        <div class="widget">
                            <div class="widget-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="widget-value">0</div>
                            <div class="widget-title">Total Students</div>
                            <div class="widget-label">Students under your supervision</div>
                        </div>
                        <div class="widget">
                            <div class="widget-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="widget-value">0</div>
                            <div class="widget-title">Partner Companies</div>
                            <div class="widget-label">Companies recruiting from campus</div>
                        </div>
                        <div class="widget">
                            <div class="widget-icon">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div class="widget-value">0</div>
                            <div class="widget-title">Active Placements</div>
                            <div class="widget-label">Ongoing placement processes</div>
                        </div>
                    </div>
                </div>

                <div id="profile-section" class="dashboard-section" style="display: none;">
                    <h3 class="content-title">Profile</h3>
                    <div class="profile-container">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user-circle" style="font-size: 5rem; color: var(--primary-color);" id="default-avatar"></i>
                                <img id="profile-image" src="" alt="Profile Photo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: none;">
                            </div>
                            <div class="profile-info">
                                <h2 id="profile-name">Faculty Name</h2>
                                <p id="profile-email">faculty@example.com</p>
                                <p><span class="badge" style="background-color: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Faculty</span></p>
                            </div>
                        </div>
                        <div class="profile-details" style="margin-top: 2rem;">
                            <div class="profile-section" style="background-color: var(--background-light); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Personal Information</h3>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Full Name</label>
                                    <input type="text" id="input-name" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                                    <input type="email" id="input-email" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;" readonly>
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Department</label>
                                    <select id="input-department" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                        <option value="computer-science">Computer Science</option>
                                        <option value="electronics">Electronics & Communication</option>
                                        <option value="mechanical">Mechanical Engineering</option>
                                        <option value="civil">Civil Engineering</option>
                                        <option value="electrical">Electrical Engineering</option>
                                        <option value="it">Information Technology</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Designation</label>
                                    <select id="input-designation" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                        <option value="professor">Professor</option>
                                        <option value="associate-professor">Associate Professor</option>
                                        <option value="assistant-professor">Assistant Professor</option>
                                        <option value="lecturer">Lecturer</option>
                                        <option value="lab-instructor">Lab Instructor</option>
                                    </select>
                                </div>
                                <button id="save-personal-info" style="background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem;">Save Changes</button>
                            </div>
                            
                            <div class="profile-section" style="background-color: var(--background-light); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Contact Information</h3>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone Number</label>
                                    <input type="tel" id="input-phone" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Office Location</label>
                                    <input type="text" id="input-office" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Office Hours</label>
                                    <input type="text" id="input-hours" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;" placeholder="e.g. Mon-Fri 10:00 AM - 12:00 PM">
                                </div>
                                <button id="save-contact-info" style="background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem;">Save Changes</button>
                            </div>
                            
                            <div class="profile-section" style="background-color: var(--background-light); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Change Password</h3>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Current Password</label>
                                    <input type="password" id="input-current-password" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">New Password</label>
                                    <input type="password" id="input-new-password" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Confirm New Password</label>
                                    <input type="password" id="input-confirm-password" class="form-control" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                </div>
                                <button id="save-password" style="background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem;">Save Changes</button>
                            </div>

                            <div class="profile-section" style="background-color: var(--background-light); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Profile Photo</h3>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Upload Photo</label>
                                    <input type="file" id="profile-photo-input" accept="image/*" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem;">
                                    <p style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-light);">Recommended: Square image, max 5MB</p>
                                </div>
                                <div id="photo-preview-container" style="margin: 1rem 0; display: none;">
                                    <h4 style="margin-bottom: 0.5rem;">Preview:</h4>
                                    <img id="photo-preview" src="" alt="Photo Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                                </div>
                                <button id="save-profile-photo" style="background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem;">Save Photo</button>
                            </div>
                            
                            <div class="profile-section" style="background-color: #fff8f8; padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 1px solid #ffe0e0;">
                                <h3 style="color: #e53e3e; margin-bottom: 1rem;">Danger Zone</h3>
                                <p style="margin-bottom: 1rem; color: var(--text-color);">Once you delete your account, there is no going back. Please be certain.</p>
                                <button id="delete-account-btn" style="background-color: #e53e3e; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; transition: all 0.3s ease;">Delete Account</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="students-section" class="dashboard-section" style="display: none;">
                    <h3 class="content-title">Students</h3>
                    <div class="student-chat-container" style="display: flex; height: calc(80vh - 80px);">
                        <!-- Student List Panel -->
                        <div class="student-list-panel" style="width: 300px; border-right: 1px solid #e2e8f0; padding: 15px; overflow-y: auto; background-color: var(--background-light); border-radius: 8px 0 0 8px;">
                            <div class="search-container" style="margin-bottom: 15px;">
                                <input type="text" id="student-search" placeholder="Search students..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 0.9rem;">
                            </div>
                            <div id="student-list" style="display: flex; flex-direction: column; gap: 10px;">
                                <!-- Student items will be dynamically populated here -->
                                <div class="loading-indicator" style="text-align: center; padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading students...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Panel -->
                        <div class="chat-panel" style="flex: 1; display: flex; flex-direction: column; background-color: white; border-radius: 0 8px 8px 0;">
                            <!-- Default view when no chat is selected -->
                            <div id="no-chat-selected" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-light);">
                                <i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 20px;"></i>
                                <p>Select a student to start counseling</p>
                            </div>
                            
                            <!-- Chat interface when a student is selected -->
                            <div id="chat-interface" style="flex: 1; display: none; flex-direction: column; height: 100%;">
                                <!-- Chat header -->
                                <div class="chat-header" style="padding: 15px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; background-color: var(--background-light); border-radius: 8px 8px 0 0;">
                                    <div style="display: flex; align-items: center;">
                                        <div id="student-chat-avatar" class="student-avatar" style="width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary-color); display: flex; align-items: center; justify-content: center; margin-right: 15px; overflow: hidden; position: relative;">
                                            <i id="student-default-avatar" class="fas fa-user" style="color: white; font-size: 1.2rem; z-index: 1;"></i>
                                            <img id="student-profile-img" src="" alt="Student Profile" style="width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; z-index: 2;">
                                    </div>
                                    <div>
                                            <div id="chat-student-name" style="font-weight: 600; font-size: 1.1rem;">Student Name</div>
                                        <div id="chat-student-email" style="font-size: 0.8rem; color: var(--text-light);">student@example.com</div>
                                        </div>
                                    </div>
                                    <div>
                                        <button id="view-student-profile" style="background-color: var(--primary-color); color: white; border: none; padding: 8px 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9rem;">
                                            <i class="fas fa-user-circle" style="margin-right: 5px;"></i> View Profile
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Chat messages -->
                                <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Messages will be populated dynamically -->
                                </div>
                                
                                <!-- Chat input area -->
                                <div class="chat-input-area" style="padding: 15px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px;">
                                    <input type="text" id="chat-input" placeholder="Type your message..." style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: var(--border-radius); font-size: 0.9rem;">
                                    <button id="send-message-btn" style="background-color: var(--primary-color); color: white; border: none; padding: 0 15px; border-radius: var(--border-radius); cursor: pointer;">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Profile Modal -->
    <div id="student-profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 800px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); position: relative; max-height: 90vh; overflow-y: auto;">
            <span id="close-profile-modal" style="position: absolute; right: 20px; top: 20px; font-size: 1.5rem; cursor: pointer;">&times;</span>
            
            <div class="student-profile-header" style="display: flex; align-items: center; margin-bottom: 30px;">
                <div id="modal-student-avatar" style="width: 100px; height: 100px; border-radius: 50%; background-color: var(--primary-color); display: flex; align-items: center; justify-content: center; margin-right: 20px; overflow: hidden; position: relative;">
                    <i id="modal-default-avatar" class="fas fa-user" style="color: white; font-size: 2.5rem; z-index: 1;"></i>
                    <img id="modal-profile-img" src="" alt="Student Profile" style="width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; z-index: 2;">
                </div>
                <div>
                    <h2 id="modal-student-name" style="margin-bottom: 5px; color: var(--primary-color);">Student Name</h2>
                    <p id="modal-student-email" style="margin-bottom: 5px; color: var(--text-light);">student@example.com</p>
                    <p id="modal-student-department" style="margin-bottom: 10px;">Department: Computer Science</p>
                    <span class="badge" style="background-color: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Student</span>
                </div>
            </div>
            
            <div class="student-profile-details">
                <div class="profile-section" style="background-color: var(--background-light); padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Personal Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <div>
                            <p style="margin-bottom: 5px; font-weight: 500;">Roll Number</p>
                            <p id="modal-student-roll" style="color: var(--text-light);">CS2021001</p>
                        </div>
                        <div>
                            <p style="margin-bottom: 5px; font-weight: 500;">Year/Semester</p>
                            <p id="modal-student-year" style="color: var(--text-light);">3rd Year / 6th Semester</p>
                        </div>
                        <div>
                            <p style="margin-bottom: 5px; font-weight: 500;">Phone</p>
                            <p id="modal-student-phone" style="color: var(--text-light);">+91 9876543210</p>
                        </div>
                    </div>
                </div>
                
                <div class="profile-section" style="background-color: var(--background-light); padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Academic Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <div>
                            <p style="margin-bottom: 5px; font-weight: 500;">CGPA</p>
                            <p id="modal-student-cgpa" style="color: var(--text-light);">8.5/10</p>
                        </div>
                        <div>
                            <p style="margin-bottom: 5px; font-weight: 500;">Backlog</p>
                            <p id="modal-student-backlog" style="color: var(--text-light);">None</p>
                        </div>
                    </div>
                </div>
                
                <div class="profile-section" style="background-color: var(--background-light); padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Skills & Interests</h3>
                    <div id="modal-student-skills" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <!-- Skills badges will be added dynamically -->
                    </div>
                    <p style="margin-bottom: 5px; font-weight: 500;">Areas of Interest</p>
                    <p id="modal-student-interests" style="color: var(--text-light);">Machine Learning, Web Development, Cloud Computing</p>
                </div>
                
                <div class="profile-section" style="background-color: var(--background-light); padding: 15px; border-radius: var(--border-radius);">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Placement Status</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <div>
                            <p style="margin-bottom: 5px; font-weight: 500;">Status</p>
                            <p id="modal-student-placement-status" style="color: var(--success-color); font-weight: 500;">Not Yet Placed</p>
                        </div>
                        <div>
                            <p style="margin-bottom: 5px; font-weight: 500;">Applications</p>
                            <p id="modal-student-applications" style="color: var(--text-light);">5 Companies</p>
                        </div>
                    </div>
                    <div id="placed-company-info" style="margin-top: 15px; display: none;">
                        <p style="margin-bottom: 5px; font-weight: 500;">Placed At</p>
                        <p id="modal-student-company" style="color: var(--text-light);">Company Name</p>
                        <p style="margin-bottom: 5px; font-weight: 500; margin-top: 10px;">Package</p>
                        <p id="modal-student-package" style="color: var(--text-light);">₹10 LPA</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="socket-client.js"></script>
    <script src="websocket-connector.js"></script>

    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            // Get login status from localStorage
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userRole = localStorage.getItem('userRole');
            
            if (isLoggedIn !== 'true' || userRole !== 'faculty') {
                // Redirect to login page if not logged in as faculty
                window.location.href = 'login.html';
            } else {
                // Get user info
                const currentUserEmail = localStorage.getItem('currentUserEmail');
                const users = JSON.parse(localStorage.getItem('campusConnectUsers')) || {};
                const currentUser = users[currentUserEmail];
                
                if (currentUser) {
                    // Display user name in sidebar
                    document.getElementById('faculty-name').textContent = currentUser.name || 'Faculty';
                }
            }
        });

        // Toggle sidebar on mobile
        document.getElementById('hamburger').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Clear login status
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUserEmail');
            localStorage.removeItem('userRole');
            
            // Redirect to login page
            window.location.href = 'login.html';
        });

        // Menu item click handling
        const menuItems = document.querySelectorAll('.menu-item');
        const dashboardSections = document.querySelectorAll('.dashboard-section');
        
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all menu items
                menuItems.forEach(mi => mi.classList.remove('active'));
                
                // Add active class to clicked menu item
                this.classList.add('active');
                
                // Get target section
                const targetSection = this.getAttribute('data-target');
                
                // Hide all sections
                dashboardSections.forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show target section if it exists
                const sectionToShow = document.getElementById(`${targetSection}-section`);
                if (sectionToShow) {
                    sectionToShow.style.display = 'block';
                } else if (targetSection !== 'dashboard') {
                    // For sections not yet implemented
                    alert(`The ${targetSection} feature will be implemented in future updates.`);
                    // Keep dashboard visible
                    document.getElementById('dashboard-section').style.display = 'block';
                    // Keep dashboard menu item active
                    document.querySelector('.menu-item[data-target="dashboard"]').classList.add('active');
                    this.classList.remove('active');
                }
            });
        });

        // Profile page functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load user profile data if available
            const currentUserEmail = localStorage.getItem('currentUserEmail');
            const users = JSON.parse(localStorage.getItem('campusConnectUsers')) || {};
            const currentUser = users[currentUserEmail];
            
            if (currentUser) {
                // Update profile header
                document.getElementById('profile-name').textContent = currentUser.name || 'Faculty Name';
                document.getElementById('profile-email').textContent = currentUserEmail;
                
                // Update form fields
                document.getElementById('input-name').value = currentUser.name || '';
                document.getElementById('input-email').value = currentUserEmail;
                
                // Set department and designation if available
                if (currentUser.department) {
                    document.getElementById('input-department').value = currentUser.department;
                }
                if (currentUser.designation) {
                    document.getElementById('input-designation').value = currentUser.designation;
                }
                
                // Set other profile fields if available
                if (currentUser.phone) {
                    document.getElementById('input-phone').value = currentUser.phone;
                }
                if (currentUser.office) {
                    document.getElementById('input-office').value = currentUser.office;
                }
                if (currentUser.officeHours) {
                    document.getElementById('input-hours').value = currentUser.officeHours;
                }
                
                // Load profile photo if available
                if (currentUser.profilePhoto) {
                    document.getElementById('profile-image').src = currentUser.profilePhoto;
                    document.getElementById('profile-image').style.display = 'block';
                    document.getElementById('default-avatar').style.display = 'none';
                    
                    // Update user avatar in sidebar as well
                    const userAvatar = document.querySelector('.user-avatar');
                    userAvatar.innerHTML = '';
                    const avatarImg = document.createElement('img');
                    avatarImg.src = currentUser.profilePhoto;
                    avatarImg.style.width = '100%';
                    avatarImg.style.height = '100%';
                    avatarImg.style.borderRadius = '50%';
                    avatarImg.style.objectFit = 'cover';
                    userAvatar.appendChild(avatarImg);
                }
            }
            
            // Save personal information
            document.getElementById('save-personal-info').addEventListener('click', function() {
                const name = document.getElementById('input-name').value;
                const department = document.getElementById('input-department').value;
                const designation = document.getElementById('input-designation').value;
                
                // Validate form
                if (!name) {
                    alert('Please enter your name');
                    return;
                }
                
                // Update user data
                currentUser.name = name;
                currentUser.department = department;
                currentUser.designation = designation;
                
                // Save to localStorage
                users[currentUserEmail] = currentUser;
                localStorage.setItem('campusConnectUsers', JSON.stringify(users));
                
                // Update profile display
                document.getElementById('profile-name').textContent = name;
                document.getElementById('faculty-name').textContent = name;
                
                alert('Personal information updated successfully');
            });
            
            // Save contact information
            document.getElementById('save-contact-info').addEventListener('click', function() {
                const phone = document.getElementById('input-phone').value;
                const office = document.getElementById('input-office').value;
                const officeHours = document.getElementById('input-hours').value;
                
                // Update user data
                currentUser.phone = phone;
                currentUser.office = office;
                currentUser.officeHours = officeHours;
                
                // Save to localStorage
                users[currentUserEmail] = currentUser;
                localStorage.setItem('campusConnectUsers', JSON.stringify(users));
                
                alert('Contact information updated successfully');
            });
            
            // Save password changes
            document.getElementById('save-password').addEventListener('click', function() {
                const currentPassword = document.getElementById('input-current-password').value;
                const newPassword = document.getElementById('input-new-password').value;
                const confirmPassword = document.getElementById('input-confirm-password').value;
                
                // Validate password fields
                if (!currentPassword) {
                    alert('Please enter your current password');
                    return;
                }
                if (!newPassword) {
                    alert('Please enter a new password');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                // Verify current password
                if (currentUser.password !== currentPassword) {
                    alert('Current password is incorrect');
                    return;
                }
                
                // Update password
                currentUser.password = newPassword;
                
                // Save to localStorage
                users[currentUserEmail] = currentUser;
                localStorage.setItem('campusConnectUsers', JSON.stringify(users));
                
                // Clear password fields
                document.getElementById('input-current-password').value = '';
                document.getElementById('input-new-password').value = '';
                document.getElementById('input-confirm-password').value = '';
                
                alert('Password updated successfully');
            });

            // Profile photo handling
            const profilePhotoInput = document.getElementById('profile-photo-input');
            const photoPreview = document.getElementById('photo-preview');
            const photoPreviewContainer = document.getElementById('photo-preview-container');
            
            // Show preview when file is selected
            profilePhotoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File is too large. Please select an image under 5MB.');
                        profilePhotoInput.value = '';
                        return;
                    }
                    
                    // Check if file is an image
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file.');
                        profilePhotoInput.value = '';
                        return;
                    }
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        photoPreview.src = event.target.result;
                        photoPreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    photoPreviewContainer.style.display = 'none';
                }
            });
            
            // Save profile photo
            document.getElementById('save-profile-photo').addEventListener('click', function() {
                if (!profilePhotoInput.files.length) {
                    alert('Please select a photo to upload.');
                    return;
                }
                
                const file = profilePhotoInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const photoData = event.target.result;
                    
                    // Save photo to user data
                    currentUser.profilePhoto = photoData;
                    users[currentUserEmail] = currentUser;
                    localStorage.setItem('campusConnectUsers', JSON.stringify(users));
                    
                    // Update profile image display
                    document.getElementById('profile-image').src = photoData;
                    document.getElementById('profile-image').style.display = 'block';
                    document.getElementById('default-avatar').style.display = 'none';
                    
                    // Update user avatar in sidebar as well
                    const userAvatar = document.querySelector('.user-avatar');
                    userAvatar.innerHTML = '';
                    const avatarImg = document.createElement('img');
                    avatarImg.src = photoData;
                    avatarImg.style.width = '100%';
                    avatarImg.style.height = '100%';
                    avatarImg.style.borderRadius = '50%';
                    avatarImg.style.objectFit = 'cover';
                    userAvatar.appendChild(avatarImg);
                    
                    // Reset input and preview
                    profilePhotoInput.value = '';
                    photoPreviewContainer.style.display = 'none';
                    
                    alert('Profile photo updated successfully.');
                };
                
                reader.readAsDataURL(file);
            });

            // Delete account functionality
            document.getElementById('delete-account-btn').addEventListener('click', function() {
                // Show confirmation dialog
                const confirmDelete = confirm('Are you sure you want to delete your account? This action cannot be undone.');
                
                if (confirmDelete) {
                    // Double-check with a password
                    const password = prompt('Please enter your password to confirm account deletion:');
                    
                    if (!password) {
                        // User cancelled the prompt
                        return;
                    }
                    
                    // Verify password
                    if (currentUser.password === password) {
                        // Delete the user from localStorage
                        delete users[currentUserEmail];
                        localStorage.setItem('campusConnectUsers', JSON.stringify(users));
                        
                        // Clear login session
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('currentUserEmail');
                        localStorage.removeItem('userRole');
                        
                        // Show success message and redirect to login page
                        alert('Your account has been successfully deleted. You will now be redirected to the login page.');
                        window.location.href = 'login.html';
                    } else {
                        alert('Incorrect password. Account deletion cancelled.');
                    }
                }
            });
        });

        // Initialize student chat functionality
        function initializeStudentChat() {
            // Get the students list element
            const studentListElement = document.getElementById('student-list');
            
            // Create demo student data if needed
            createOrUpdateDemoStudents();
            
            // Load students
            loadStudents();
            
            // Search functionality
            const searchInput = document.getElementById('student-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterStudents(this.value);
                });
            }
            
            // Send message event listener
            const sendButton = document.getElementById('send-message-btn');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessageToStudent);
            }
            
            // Enter key in chat input
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessageToStudent();
                    }
                });
            }
            
            // Setup student profile view button
            const viewProfileBtn = document.getElementById('view-student-profile');
            if (viewProfileBtn) {
                viewProfileBtn.addEventListener('click', function() {
                    if (window.currentChatStudent) {
                        showStudentProfile(window.currentChatStudent.email);
                    }
                });
            }
            
            // Setup close modal button
            const closeModalBtn = document.getElementById('close-profile-modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', function() {
                    document.getElementById('student-profile-modal').style.display = 'none';
                });
            }
            
            // Initialize WebSocket connection
            if (typeof chatSocket !== 'undefined' && chatSocket.init) {
                // Initialize the socket connection
                if (chatSocket.init()) {
                    console.log('Chat socket initialized successfully');
                    
                    // Login with current user
                    const currentUserEmail = localStorage.getItem('currentUserEmail');
                    if (currentUserEmail) {
                        chatSocket.login(currentUserEmail, 'faculty');
                        
                        // Set callbacks for real-time chat updates
                        chatSocket.setCallbacks({
                            onNewMessage: handleNewChatMessage,
                            onMessageSent: handleMessageSent,
                            onMessagesRead: handleMessagesRead
                        });
                    }
                } else {
                    console.error('Failed to initialize chat socket');
                }
            } else {
                console.error('chatSocket not defined or missing init method');
            }
            
            // Start periodic check for unread messages
            setInterval(checkForUnreadMessages, 10000); // Check every 10 seconds
            checkForUnreadMessages(); // Initial check
        }
        
        // Create or update demo student data
        function createOrUpdateDemoStudents() {
            console.log('Checking if demo students need to be created...');
            
            const users = JSON.parse(localStorage.getItem('campusConnectUsers') || '{}');
            
            // Check if there are any student accounts
            const studentCount = Object.keys(users).filter(email => users[email] && users[email].userType === 'student').length;
            
            if (studentCount === 0) {
                // Create placeholder profile photo data URIs
                const malePhotoPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzRmNDZlNSIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjgwIiByPSI0MCIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik00MCAxODBjMC0zNSAyNS02MCAnKyA2MCAtNjAgNjAgMCAyNSA2MCAnKyAyNSArNjAgOTUgMTgweiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==';
                const femalePhotoPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2U4MzQ4ZSIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjgwIiByPSI0MCIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik01MCAxODBjMTAtNDAgMzAtNjAgNTAtNjAgMjAgMCA0MCAyMCA1MCA2MHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=';
                const indianPhotoPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzZiNDc4ZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjgwIiByPSI0MCIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik00NyAxODBjMC0zNyAyNC01My41MzUgNTMtNTMuNTM1IDI5IDAgNTMgMTYuNTM1IDUzIDUzLjUzNUg0N3oiIGZpbGw9IiNmZmYiLz48L3N2Zz4=';
                
                console.log('No student accounts found. Creating demo students...');
                
                // Create sample demo students
                const demoStudents = [
                    {
                        email: 'john.doe@student.edu',
                        name: 'John Doe',
                        department: 'Computer Science',
                        userType: 'student',
                        password: 'password',
                        skills: ['Java', 'Python', 'React', 'Node.js'],
                        interests: 'Web Development, AI, Cloud Computing',
                        cgpa: '8.7/10',
                        year: '3rd Year',
                        rollNumber: 'CS2021045',
                        phone: '+91 9876543210',
                        applicationCount: 3,
                        placementStatus: 'Not placed',
                        profilePhoto: malePhotoPlaceholder
                    },
                    {
                        email: 'jane.smith@student.edu',
                        name: 'Jane Smith',
                        department: 'Electronics',
                        userType: 'student',
                        password: 'password',
                        skills: ['C++', 'VHDL', 'PCB Design', 'Arduino'],
                        interests: 'Embedded Systems, IoT, Robotics',
                        cgpa: '9.2/10',
                        year: '4th Year',
                        rollNumber: 'EC2020012',
                        phone: '+91 9876543211',
                        applicationCount: 7,
                        placementStatus: 'Placed',
                        placedAt: 'Samsung Electronics',
                        package: '₹12.5 LPA',
                        profilePhoto: femalePhotoPlaceholder
                    },
                    {
                        email: 'raj.patel@student.edu',
                        name: 'Raj Patel',
                        department: 'Mechanical Engineering',
                        userType: 'student',
                        password: 'password',
                        skills: ['AutoCAD', 'SolidWorks', 'MATLAB', '3D Printing'],
                        interests: 'Automotive Design, Thermal Engineering, Robotics',
                        cgpa: '8.5/10',
                        year: '3rd Year',
                        rollNumber: 'ME2021023',
                        phone: '+91 9876543212',
                        applicationCount: 2,
                        placementStatus: 'Not placed',
                        profilePhoto: indianPhotoPlaceholder
                    },
                    {
                        email: 'priya.sharma@student.edu',
                        name: 'Priya Sharma',
                        department: 'Information Technology',
                        userType: 'student',
                        password: 'password',
                        skills: ['JavaScript', 'React', 'UI/UX Design', 'MongoDB'],
                        interests: 'Full Stack Development, Data Visualization, AR/VR',
                        cgpa: '9.1/10',
                        year: '2nd Year',
                        rollNumber: 'IT2022033',
                        phone: '+91 9876543213',
                        applicationCount: 0,
                        placementStatus: 'Not placed',
                        profilePhoto: femalePhotoPlaceholder
                    }
                ];
                
                // Add demo students to users object
                demoStudents.forEach(student => {
                    users[student.email] = student;
                });
                
                // Save to localStorage
                localStorage.setItem('campusConnectUsers', JSON.stringify(users));
                console.log('Demo student accounts created');
            } else {
                console.log(`Found ${studentCount} existing student accounts`);
                
                // Check if existing students have all required fields and add them if missing
                let updated = false;
                
                Object.keys(users).forEach(email => {
                    const user = users[email];
                    if (user && user.userType === 'student') {
                        // Ensure student has a department
                        if (!user.department) {
                            const departments = ['Computer Science', 'Electronics', 'Mechanical Engineering', 'Civil Engineering', 'Information Technology'];
                            user.department = departments[Math.floor(Math.random() * departments.length)];
                            updated = true;
                        }
                        
                        // Ensure student has a proper name
                        if (!user.name) {
                            // Try to construct from firstName and lastName if available
                            if (user.firstName && user.lastName) {
                                user.name = `${user.firstName} ${user.lastName}`;
                            } else {
                                // Extract name from email if possible
                                const emailName = email.split('@')[0];
                                if (emailName) {
                                    user.name = emailName.split('.').map(part => 
                                        part.charAt(0).toUpperCase() + part.slice(1)
                                    ).join(' ');
                                } else {
                                    user.name = 'Student User';
                                }
                            }
                            updated = true;
                        }
                    }
                });
                
                if (updated) {
                    localStorage.setItem('campusConnectUsers', JSON.stringify(users));
                    console.log('Updated existing student accounts with missing fields');
                }
            }
        }
        
        // Function to show student profile in modal
        function showStudentProfile(studentEmail) {
            if (!studentEmail) return;
            
            // Get user data
            const users = JSON.parse(localStorage.getItem('campusConnectUsers') || '{}');
            const studentData = users[studentEmail] || window.currentStudentData || { email: studentEmail };
            
            console.log("Showing profile for student:", studentEmail);
            console.log("Student data:", studentData);
            
            // Update profile modal with student data
            document.getElementById('modal-student-name').textContent = studentData.name || 'Student';
            document.getElementById('modal-student-email').textContent = studentEmail;
            document.getElementById('modal-student-department').textContent = `Department: ${studentData.department || 'Not specified'}`;
            
            // Update profile image
            const defaultAvatar = document.getElementById('modal-default-avatar');
            const profileImg = document.getElementById('modal-profile-img');
            
            if (studentData.profilePhoto) {
                profileImg.src = studentData.profilePhoto;
                profileImg.style.display = 'block';
                defaultAvatar.style.display = 'none';
            } else {
                profileImg.style.display = 'none';
                defaultAvatar.style.display = 'block';
            }
            
            // Update personal information
            document.getElementById('modal-student-roll').textContent = studentData.rollNumber || 'Not available';
            document.getElementById('modal-student-year').textContent = studentData.year || 'Not available';
            document.getElementById('modal-student-phone').textContent = studentData.phone || 'Not available';
            
            // Update academic information
            document.getElementById('modal-student-cgpa').textContent = studentData.cgpa || 'Not available';
            document.getElementById('modal-student-backlog').textContent = studentData.backlog || 'None';
            
            // Update skills & interests
            const skillsContainer = document.getElementById('modal-student-skills');
            skillsContainer.innerHTML = '';
            
            if (studentData.skills && Array.isArray(studentData.skills) && studentData.skills.length > 0) {
                studentData.skills.forEach(skill => {
                    const badge = document.createElement('span');
                    badge.className = 'skill-badge';
                    badge.textContent = skill;
                    badge.style.backgroundColor = 'var(--primary-color)';
                    badge.style.color = 'white';
                    badge.style.padding = '4px 10px';
                    badge.style.borderRadius = '20px';
                    badge.style.fontSize = '0.8rem';
                    skillsContainer.appendChild(badge);
                });
            } else {
                skillsContainer.innerHTML = '<p style="color: var(--text-light);">No skills specified</p>';
            }
            
            document.getElementById('modal-student-interests').textContent = studentData.interests || 'Not specified';
            
            // Update placement status
            const placementStatus = studentData.placementStatus || 'Not placed';
            const statusElement = document.getElementById('modal-student-placement-status');
            statusElement.textContent = placementStatus;
            
            if (placementStatus.toLowerCase().includes('placed')) {
                statusElement.style.color = 'var(--success-color)';
                document.getElementById('placed-company-info').style.display = 'block';
                document.getElementById('modal-student-company').textContent = studentData.placedAt || 'Not specified';
                document.getElementById('modal-student-package').textContent = studentData.package || 'Not specified';
            } else {
                statusElement.style.color = 'var(--text-light)';
                document.getElementById('placed-company-info').style.display = 'none';
            }
            
            document.getElementById('modal-student-applications').textContent = `${studentData.applicationCount || 0} Companies`;
            
            // Show the modal
            document.getElementById('student-profile-modal').style.display = 'block';
        }
        
        // Load students for chat
        function loadStudents() {
            const studentList = document.getElementById('student-list');
            if (!studentList) return;
            
            console.log('Loading students from localStorage...');
            
            // Get all users from localStorage
            const users = JSON.parse(localStorage.getItem('campusConnectUsers') || '{}');
            const students = [];
            
            // Filter out only student accounts
            Object.keys(users).forEach(email => {
                const user = users[email];
                if (user && user.userType === 'student') {
                    // Get student's display name with fallbacks
                    let displayName = 'Student';
                    if (user.name) {
                        displayName = user.name;
                    } else if (user.firstName && user.lastName) {
                        displayName = `${user.firstName} ${user.lastName}`;
                    }
                    
                    console.log(`Found student: ${email}, Name: ${displayName}, Department: ${user.department || 'N/A'}`);
                    
                    students.push({
                        email: email,
                        name: displayName,
                        department: user.department || 'N/A',
                        profilePhoto: user.profilePhoto || null,
                        hasUnread: false
                    });
                }
            });
            
            // Clear the list first
            studentList.innerHTML = '';
            
            if (students.length === 0) {
                console.log('No students found, creating demo students...');
                // Create demo students and try again
                createOrUpdateDemoStudents();
                // Call this function again after creating demo students
                setTimeout(loadStudents, 100);
                return;
            }
            
            console.log(`Found ${students.length} students in total`);
            
            // Sort by name
            students.sort((a, b) => a.name.localeCompare(b.name));
            
            // Check for unread messages
            const unreadInfo = checkForUnreadMessages();
            
            // Create a list item for each student
            students.forEach(student => {
                // Check if this student has unread messages
                const unreadStudent = unreadInfo.students.find(s => s.email === student.email);
                if (unreadStudent) {
                    student.hasUnread = true;
                    student.unreadCount = unreadStudent.count;
                }
                
                createStudentListItem(student);
            });
            
            // Force update student list on DOM update
            setTimeout(() => {
                const avatars = document.querySelectorAll('.student-list-avatar');
                console.log(`Updated ${avatars.length} student avatars in the list`);
            }, 100);
        }
        
        // Create a student list item
        function createStudentListItem(student) {
            const studentList = document.getElementById('student-list');
            if (!studentList) return;
            
            const item = document.createElement('div');
            item.className = 'student-item';
            item.setAttribute('data-student-email', student.email);
            item.style.padding = '10px';
            item.style.borderRadius = 'var(--border-radius)';
            item.style.backgroundColor = 'white';
            item.style.cursor = 'pointer';
            item.style.display = 'flex';
            item.style.alignItems = 'center';
            item.style.justifyContent = 'space-between';
            item.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
            item.style.marginBottom = '8px';
            
            // Add hover effect
            item.addEventListener('mouseover', function() {
                this.style.backgroundColor = 'var(--background-light)';
            });
            item.addEventListener('mouseout', function() {
                this.style.backgroundColor = 'white';
            });
            
            // Left part with student info
            const infoDiv = document.createElement('div');
            infoDiv.style.display = 'flex';
            infoDiv.style.alignItems = 'center';
            
            // Student avatar container
            const avatarContainer = document.createElement('div');
            avatarContainer.className = 'student-list-avatar';
            avatarContainer.style.width = '40px';
            avatarContainer.style.height = '40px';
            avatarContainer.style.borderRadius = '50%';
            avatarContainer.style.backgroundColor = 'var(--primary-color)';
            avatarContainer.style.display = 'flex';
            avatarContainer.style.alignItems = 'center';
            avatarContainer.style.justifyContent = 'center';
            avatarContainer.style.marginRight = '10px';
            avatarContainer.style.overflow = 'hidden';
            avatarContainer.style.position = 'relative';
            
            // Default avatar icon (always create as fallback)
            const defaultIcon = document.createElement('i');
            defaultIcon.className = 'fas fa-user';
            defaultIcon.style.color = 'white';
            defaultIcon.style.zIndex = '1';
            avatarContainer.appendChild(defaultIcon);
            
            // Try to add profile image if available
            if (student.profilePhoto) {
                const img = document.createElement('img');
                img.src = student.profilePhoto;
                img.alt = student.name;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.position = 'absolute';
                img.style.top = '0';
                img.style.left = '0';
                img.style.zIndex = '2';
                
                // On error, show default icon
                img.onerror = function() {
                    img.style.display = 'none';
                };
                
                // On successful load, hide default icon
                img.onload = function() {
                    defaultIcon.style.display = 'none';
                };
                
                avatarContainer.appendChild(img);
            }
            
            const textDiv = document.createElement('div');
            
            // Student name
            const name = document.createElement('div');
            name.textContent = student.name;
            name.style.fontWeight = '500';
            name.style.fontSize = '0.9rem';
            
            // Student department
            const dept = document.createElement('div');
            // Format department to be more readable and consistent
            let deptDisplay = student.department;
            if (deptDisplay.toLowerCase().includes('computer science')) {
                deptDisplay = 'Computer Science';
            } else if (deptDisplay.toLowerCase().includes('electronic')) {
                deptDisplay = 'Electronics';
            } else if (deptDisplay.toLowerCase().includes('mechanical')) {
                deptDisplay = 'Mechanical';
            } else if (deptDisplay.toLowerCase().includes('information technology') || deptDisplay === 'IT') {
                deptDisplay = 'Information Technology';
            } else if (deptDisplay.toLowerCase().includes('civil')) {
                deptDisplay = 'Civil Engineering';
            }
            dept.textContent = deptDisplay;
            dept.style.fontSize = '0.8rem';
            dept.style.color = 'var(--text-light)';
            
            textDiv.appendChild(name);
            textDiv.appendChild(dept);
            infoDiv.appendChild(avatarContainer);
            infoDiv.appendChild(textDiv);
            
            // Unread indicator if applicable
            if (student.hasUnread) {
                const unreadIndicator = document.createElement('span');
                unreadIndicator.className = 'unread-indicator';
                unreadIndicator.textContent = student.unreadCount || '';
                unreadIndicator.style.backgroundColor = 'var(--danger-color)';
                unreadIndicator.style.color = 'white';
                unreadIndicator.style.borderRadius = '50%';
                unreadIndicator.style.padding = '2px 6px';
                unreadIndicator.style.fontSize = '0.7rem';
                item.appendChild(unreadIndicator);
            }
            
            item.appendChild(infoDiv);
            
            // Add click event to open chat
            item.addEventListener('click', function() {
                openChatWithStudent(student.email, student.name);
            });
            
            studentList.appendChild(item);
        }
        
        // Filter students based on search term
        function filterStudents(searchTerm) {
            const studentItems = document.querySelectorAll('.student-item');
            searchTerm = searchTerm.toLowerCase();
            
            studentItems.forEach(item => {
                const studentName = item.querySelector('div > div:first-child').textContent.toLowerCase();
                const studentDept = item.querySelector('div > div:nth-child(2)').textContent.toLowerCase();
                const studentEmail = item.getAttribute('data-student-email').toLowerCase();
                
                if (studentName.includes(searchTerm) || studentDept.includes(searchTerm) || studentEmail.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Check for unread messages
        function checkForUnreadMessages() {
            const currentUserEmail = localStorage.getItem('currentUserEmail');
            if (!currentUserEmail) return { total: 0, students: [] };
            
            const chats = JSON.parse(localStorage.getItem('campusConnectChats') || '{}');
            let totalUnread = 0;
            const unreadByStudent = [];
            
            // Check each chat
            Object.keys(chats).forEach(chatKey => {
                // Check if this chat involves the current faculty
                if (chatKey.includes(currentUserEmail)) {
                    const chat = chats[chatKey];
                    
                    // Get the other participant's email (student)
                    const parts = chatKey.split('_');
                    const studentEmail = parts[0] === currentUserEmail ? parts[1] : parts[0];
                    
                    let studentUnreadCount = 0;
                    
                    // Count unread messages from this student
                    if (chat.messages && Array.isArray(chat.messages)) {
                        chat.messages.forEach(message => {
                            if (message.sender === studentEmail && !message.read) {
                                totalUnread++;
                                studentUnreadCount++;
                            }
                        });
                    }
                    
                    // If student has unread messages, add to list
                    if (studentUnreadCount > 0) {
                        const users = JSON.parse(localStorage.getItem('campusConnectUsers') || '{}');
                        const student = users[studentEmail];
                        let studentName = "Student";
                        
                        if (student) {
                            studentName = student.name || "Student";
                        }
                        
                        unreadByStudent.push({
                            email: studentEmail,
                            name: studentName,
                            count: studentUnreadCount
                        });
                    }
                }
            });
            
            // Update unread indicators in the student list
            updateUnreadIndicators(unreadByStudent);
            
            return {
                total: totalUnread,
                students: unreadByStudent
            };
        }
        
        // Update unread indicators in the UI
        function updateUnreadIndicators(unreadStudents) {
            const studentItems = document.querySelectorAll('.student-item');
            
            // Reset all indicators first
            studentItems.forEach(item => {
                const indicator = item.querySelector('.unread-indicator');
                if (indicator) {
                    item.removeChild(indicator);
                }
            });
            
            // Add indicators for students with unread messages
            unreadStudents.forEach(student => {
                const item = document.querySelector(`.student-item[data-student-email="${student.email}"]`);
                if (item) {
                    const unreadIndicator = document.createElement('span');
                    unreadIndicator.className = 'unread-indicator';
                    unreadIndicator.textContent = student.count;
                    unreadIndicator.style.backgroundColor = 'var(--danger-color)';
                    unreadIndicator.style.color = 'white';
                    unreadIndicator.style.borderRadius = '50%';
                    unreadIndicator.style.padding = '2px 6px';
                    unreadIndicator.style.fontSize = '0.7rem';
                    item.appendChild(unreadIndicator);
                }
            });
        }
        
        // Open chat with a student
        function openChatWithStudent(studentEmail, studentName) {
            // Update global variable for current chat
            window.currentChatStudent = { email: studentEmail, name: studentName };
            
            // Get user data
            const users = JSON.parse(localStorage.getItem('campusConnectUsers') || '{}');
            const studentData = users[studentEmail];
            
            // Store student data in a global variable for easy access
            window.currentStudentData = studentData || {
                email: studentEmail,
                name: studentName
            };
            
            // Update chat header with name and email
            document.getElementById('chat-student-name').textContent = studentName;
            document.getElementById('chat-student-email').textContent = studentEmail;
            
            // Update profile image in chat header
            const defaultAvatar = document.getElementById('student-default-avatar');
            const profileImg = document.getElementById('student-profile-img');
            
            if (studentData && studentData.profilePhoto) {
                // Set profile image
                profileImg.src = studentData.profilePhoto;
                profileImg.style.display = 'block';
                defaultAvatar.style.display = 'none';
            } else {
                // Use default avatar
                profileImg.style.display = 'none';
                defaultAvatar.style.display = 'block';
            }
            
            // Show chat interface, hide no-chat message
            document.getElementById('no-chat-selected').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';
            
            // Load chat history
            loadChatHistory(studentEmail);
            
            // Mark messages from this student as read
            markMessagesAsRead(studentEmail);
            
            // Highlight the selected student in the list
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                if (item.getAttribute('data-student-email') === studentEmail) {
                    item.style.backgroundColor = 'var(--background-light)';
                } else {
                    item.style.backgroundColor = 'white';
                }
            });
        }
        
        // Load chat history with a student
        function loadChatHistory(studentEmail) {
            const chatMessagesContainer = document.getElementById('chat-messages');
            const currentUserEmail = localStorage.getItem('currentUserEmail');
            
            if (!chatMessagesContainer || !currentUserEmail || !studentEmail) {
                console.error("Missing required elements for loading chat history");
                return;
            }
            
            // Clear the container
            chatMessagesContainer.innerHTML = '';
            
            // Get chat history from localStorage or via socket
            let messages = [];
            
            // Log for debugging
            console.log("Loading chat history between faculty", currentUserEmail, "and student", studentEmail);
            
            // Check localStorage directly
            const chats = JSON.parse(localStorage.getItem('campusConnectChats') || '{}');
            console.log("All chats in localStorage:", Object.keys(chats));
            
            // Construct both possible chat keys
            const chatKey1 = `${currentUserEmail}_${studentEmail}`;
            const chatKey2 = `${studentEmail}_${currentUserEmail}`;
            
            console.log("Looking for chat keys:", chatKey1, "or", chatKey2);
            
            // Check both keys in localStorage
            if (chats[chatKey1] && chats[chatKey1].messages) {
                console.log(`Found messages under key ${chatKey1}:`, chats[chatKey1].messages.length);
                messages = messages.concat(chats[chatKey1].messages);
            }
            
            if (chats[chatKey2] && chats[chatKey2].messages) {
                console.log(`Found messages under key ${chatKey2}:`, chats[chatKey2].messages.length);
                messages = messages.concat(chats[chatKey2].messages);
            }
            
            // Try to get via socket API if available
            if (typeof chatSocket !== 'undefined' && chatSocket.getChatHistory) {
                const socketMessages = chatSocket.getChatHistory(studentEmail);
                if (socketMessages && socketMessages.length > 0) {
                    console.log("Got messages from socket API:", socketMessages.length);
                    
                    // If we already have messages from localStorage, merge them
                    if (messages.length > 0) {
                        // Create a set of existing message IDs to avoid duplicates
                        const existingIds = new Set();
                        messages.forEach(msg => {
                            // Create a unique ID from sender, timestamp and text
                            const msgId = `${msg.sender}-${msg.timestamp}-${msg.text.substring(0, 10)}`;
                            existingIds.add(msgId);
                        });
                        
                        // Add messages from socket that aren't already in the list
                        socketMessages.forEach(msg => {
                            const msgId = `${msg.sender}-${msg.timestamp}-${msg.text.substring(0, 10)}`;
                            if (!existingIds.has(msgId)) {
                                messages.push(msg);
                            }
                        });
                    } else {
                        // Just use socket messages if none from localStorage
                        messages = socketMessages;
                    }
                }
            }
            
            // Sort by timestamp
            messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            console.log("Total messages to display:", messages.length);
            
            if (messages.length === 0) {
                // No messages yet
                const noMessagesDiv = document.createElement('div');
                noMessagesDiv.style.textAlign = 'center';
                noMessagesDiv.style.padding = '20px';
                noMessagesDiv.style.color = 'var(--text-light)';
                noMessagesDiv.innerHTML = 'No messages yet. Send a message to start the conversation.';
                chatMessagesContainer.appendChild(noMessagesDiv);
                return;
            }
            
            // Add each message to the container
            let lastDate = null;
            
            messages.forEach(message => {
                // Log each message for debugging
                console.log("Displaying message:", message);
                
                // Check if we need to add a date separator
                const messageDate = new Date(message.timestamp).toDateString();
                if (!lastDate || lastDate !== messageDate) {
                    // Add date separator
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.style.textAlign = 'center';
                    dateSeparator.style.margin = '10px 0';
                    dateSeparator.style.position = 'relative';
                    
                    const dateText = document.createElement('span');
                    dateText.style.backgroundColor = 'white';
                    dateText.style.padding = '0 10px';
                    dateText.style.position = 'relative';
                    dateText.style.zIndex = '1';
                    dateText.style.color = 'var(--text-light)';
                    dateText.style.fontSize = '0.8rem';
                    dateText.textContent = formatDateForChat(messageDate);
                    
                    const line = document.createElement('div');
                    line.style.position = 'absolute';
                    line.style.top = '50%';
                    line.style.left = '0';
                    line.style.right = '0';
                    line.style.height = '1px';
                    line.style.backgroundColor = '#e2e8f0';
                    line.style.zIndex = '0';
                    
                    dateSeparator.appendChild(line);
                    dateSeparator.appendChild(dateText);
                    chatMessagesContainer.appendChild(dateSeparator);
                    
                    lastDate = messageDate;
                }
                
                // Create message element
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message';
                
                // Set alignment based on sender
                const isFromMe = message.sender === currentUserEmail;
                messageElement.style.alignSelf = isFromMe ? 'flex-end' : 'flex-start';
                messageElement.style.maxWidth = '70%';
                messageElement.style.padding = '10px 15px';
                messageElement.style.borderRadius = '18px';
                messageElement.style.marginBottom = '10px';
                messageElement.style.backgroundColor = isFromMe ? 'var(--primary-color)' : 'var(--background-light)';
                messageElement.style.color = isFromMe ? 'white' : 'var(--text-color)';
                messageElement.style.position = 'relative';
                
                // Message text
                const messageText = document.createElement('div');
                messageText.textContent = message.text;
                messageText.style.wordBreak = 'break-word';
                
                // Message timestamp
                const timestamp = document.createElement('div');
                timestamp.style.fontSize = '0.7rem';
                timestamp.style.marginTop = '5px';
                timestamp.style.textAlign = 'right';
                timestamp.style.color = isFromMe ? 'rgba(255,255,255,0.7)' : 'var(--text-light)';
                timestamp.textContent = formatTimeForChat(message.timestamp);
                
                // Read status for outgoing messages
                if (isFromMe) {
                    const readStatus = document.createElement('span');
                    readStatus.style.marginLeft = '5px';
                    readStatus.style.fontSize = '0.7rem';
                    readStatus.innerHTML = message.read ? '<i class="fas fa-check-double"></i>' : '<i class="fas fa-check"></i>';
                    timestamp.appendChild(readStatus);
                }
                
                messageElement.appendChild(messageText);
                messageElement.appendChild(timestamp);
                chatMessagesContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        
        // Format date for chat display
        function formatDateForChat(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric'
                });
            }
        }
        
        // Format time for chat display
        function formatTimeForChat(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }
        
        // Mark messages from a student as read
        function markMessagesAsRead(studentEmail) {
            const currentUserEmail = localStorage.getItem('currentUserEmail');
            if (!currentUserEmail || !studentEmail) return;
            
            const chats = JSON.parse(localStorage.getItem('campusConnectChats') || '{}');
            
            // Check both possible chat keys
            const chatKey1 = `${currentUserEmail}_${studentEmail}`;
            const chatKey2 = `${studentEmail}_${currentUserEmail}`;
            
            let chatKey = null;
            if (chats[chatKey1]) chatKey = chatKey1;
            if (chats[chatKey2]) chatKey = chatKey2;
            
            if (chatKey && typeof chatSocket !== 'undefined' && chatSocket.markMessagesAsRead) {
                chatSocket.markMessagesAsRead(studentEmail, chatKey);
            } else {
                // Fallback to direct localStorage update
                let updated = false;
                
                if (chats[chatKey1] && chats[chatKey1].messages) {
                    chats[chatKey1].messages.forEach(msg => {
                        if (msg.sender === studentEmail && !msg.read) {
                            msg.read = true;
                            updated = true;
                        }
                    });
                }
                
                if (chats[chatKey2] && chats[chatKey2].messages) {
                    chats[chatKey2].messages.forEach(msg => {
                        if (msg.sender === studentEmail && !msg.read) {
                            msg.read = true;
                            updated = true;
                        }
                    });
                }
                
                if (updated) {
                    localStorage.setItem('campusConnectChats', JSON.stringify(chats));
                }
            }
            
            // Update UI to remove unread indicators
            updateUnreadIndicators(checkForUnreadMessages().students);
        }
        
        // Send message to student
        function sendMessageToStudent() {
            const messageInput = document.getElementById('chat-input');
            if (!messageInput || !window.currentChatStudent) return;
            
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            const currentUserEmail = localStorage.getItem('currentUserEmail');
            if (!currentUserEmail) {
                alert('You must be logged in to send messages.');
                return;
            }
            
            // Clear input field
            messageInput.value = '';
            
            // Send via WebSocket if available
            if (typeof chatSocket !== 'undefined' && chatSocket.sendMessage) {
                if (chatSocket.sendMessage(window.currentChatStudent.email, messageText)) {
                    console.log('Message sent via socket');
                } else {
                    console.error('Failed to send message via socket');
                    // Fallback to direct localStorage saving
                    saveMessageToLocalStorage(window.currentChatStudent.email, messageText);
                }
            } else {
                // Fallback to direct localStorage saving
                saveMessageToLocalStorage(window.currentChatStudent.email, messageText);
            }
            
            // Refresh the chat
            loadChatHistory(window.currentChatStudent.email);
        }
        
        // Save message directly to localStorage
        function saveMessageToLocalStorage(recipientEmail, messageText) {
            const currentUserEmail = localStorage.getItem('currentUserEmail');
            if (!currentUserEmail) return false;
            
            const chats = JSON.parse(localStorage.getItem('campusConnectChats') || '{}');
            const chatKey = `${currentUserEmail}_${recipientEmail}`;
            
            if (!chats[chatKey]) {
                chats[chatKey] = { messages: [] };
            }
            
            const message = {
                sender: currentUserEmail,
                text: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            chats[chatKey].messages.push(message);
            localStorage.setItem('campusConnectChats', JSON.stringify(chats));
            
            console.log('Message saved to localStorage');
            return true;
        }
        
        // Handle new incoming message via WebSocket
        function handleNewChatMessage(data) {
            console.log('New message received:', data);
            
            // Extract sender email from message or chat key
            let senderEmail = data.message.sender;
            
            // If chat is open with the sender, refresh it
            if (window.currentChatStudent && 
                (data.chatKey.includes(window.currentChatStudent.email) || 
                senderEmail === window.currentChatStudent.email)) {
                
                console.log('Chat is open with sender, refreshing chat');
                loadChatHistory(window.currentChatStudent.email);
                
                // Mark as read since chat is open
                if (typeof chatSocket !== 'undefined' && chatSocket.markMessagesAsRead) {
                    chatSocket.markMessagesAsRead(senderEmail, data.chatKey);
                }
            } else {
                // If this is a student message, we need to check unread messages
                const currentUserEmail = localStorage.getItem('currentUserEmail');
                
                // If this message is not from the current user, it's likely from a student
                if (senderEmail !== currentUserEmail) {
                    console.log('Message from student, checking unread messages');
                    // Get the student email from the chat key if not already found
                    if (!senderEmail) {
                        const parts = data.chatKey.split('_');
                        senderEmail = parts[0] === currentUserEmail ? parts[1] : parts[0];
                    }
                    
                    // Store the message in localStorage (in case it wasn't already)
                    const chats = JSON.parse(localStorage.getItem('campusConnectChats') || '{}');
                    const chatKey = data.chatKey || `${currentUserEmail}_${senderEmail}`;
                    
                    if (!chats[chatKey]) {
                        chats[chatKey] = { messages: [] };
                    }
                    
                    // Check if this message is already in localStorage
                    const messageExists = chats[chatKey].messages.some(msg => 
                        msg.sender === data.message.sender && 
                        msg.timestamp === data.message.timestamp && 
                        msg.text === data.message.text
                    );
                    
                    if (!messageExists) {
                        chats[chatKey].messages.push(data.message);
                        localStorage.setItem('campusConnectChats', JSON.stringify(chats));
                        console.log('Message stored in localStorage');
                    }
                }
            }
            
            // Update unread indicators
            const unreadInfo = checkForUnreadMessages();
            updateUnreadIndicators(unreadInfo.students);
            
            // Refresh student list to show new students if needed
            const studentList = document.querySelector('#student-list');
            if (studentList && studentList.children.length <= 1) {
                loadStudents();
            }
        }
        
        // Handle confirmation of message sent via WebSocket
        function handleMessageSent(data) {
            console.log('Message sent confirmation:', data);
            
            // Refresh the chat if it's the current one
            if (window.currentChatStudent && data.chatKey.includes(window.currentChatStudent.email)) {
                loadChatHistory(window.currentChatStudent.email);
            }
        }
        
        // Handle messages being marked as read
        function handleMessagesRead(data) {
            console.log('Messages read by:', data.reader);
            
            // Refresh the chat to update read indicators if it's open
            if (window.currentChatStudent && data.chatKey.includes(window.currentChatStudent.email)) {
                loadChatHistory(window.currentChatStudent.email);
            }
        }
        
        // Initialize student chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeStudentChat();
        });
    </script>
</body>
</html> 